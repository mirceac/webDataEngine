<link rel="import" href="/assets/components/polymer/polymer.html">
<link rel="import" href="/assets/components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/assets/components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/assets/components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/assets/components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/assets/components/iron-icons/iron-icons.html">
<link rel="import" href="/assets/components/paper-styles/paper-styles.html">
<link rel="import" href="/assets/components/paper-menu/paper-menu.html">
<link rel="import" href="/assets/components/paper-item/paper-item.html">
<link rel="import" href="/assets/components/iron-pages/iron-pages.html">
<link rel="import" href="/assets/components/iron-ajax/iron-ajax.html">
<link rel="import" href="/assets/components/paper-button/paper-button.html">

<link type="text/css" rel="stylesheet" href="/assets/components/bootstrap/dist/css/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="/assets/components/alpaca/dist/alpaca/bootstrap/alpaca.min.css">

<script type="text/javascript" src="/assets/components/bootstrap-multiselect/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript" src="/assets/components/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/components/handlebars/handlebars.js"></script>
<script type="text/javascript" src="/assets/components/alpaca/dist/alpaca/bootstrap/alpaca.min.js"></script>

<dom-module id="polycom-template">
    <style>
        paper-header-panel[main]{
        background-color: var(--paper-blue-100);
        }
        paper-header-panel[drawer]{
        background-color: var(--paper-blue-200);
        }
        paper-menu.menu{
        background-color: var(--paper-blue-200);
        }
        paper-item.menu{
        background-color: var(--paper-blue-200);
        }
        paper-toolbar.main{
        background-color: var(--paper-blue-500);
        }
        paper-toolbar.drawer{
        background-color: var(--paper-blue-900);
        }
        paper-button.colored {
        color: black;
        background: lightgreen;
        }
    </style>
    <template>
        <iron-ajax
                id="addPhoneAction"
                url="/api/phones/add"
                method="POST"
                content-type="application/json"
                on-response="phoneAdded"
                handle-as="json">
        </iron-ajax>
        <iron-ajax
                id="modifyPhoneAction"
                url="/api/phones/modify/{{serialNumber}}"
                method="POST"
                content-type="application/json"
                on-response="phoneModified"
                handle-as="json">
        </iron-ajax>
        <iron-ajax
                id="getPhoneAction"
                url="/api/phones/get/{{serialNumber}}"
                method="GET"
                on-response="phoneRetrieved"
                handle-as="json">
        </iron-ajax>
        <paper-drawer-panel>
            <paper-header-panel drawer>
                <paper-toolbar class="drawer">
                    <div flex>Description</div>
                </paper-toolbar>
                <paper-menu selected="{{selected}}" class="menu">
                    <template is="dom-repeat" items="{{menu}}">
                        <paper-item class="menu">{{item}}</paper-item>
                    </template>
                </paper-menu>
            </paper-header-panel>
            <paper-header-panel main>
                <paper-toolbar class="main">
                    <paper-icon-button paper-drawer-toggle icon="menu"></paper-icon-button>
                    <span title class="flex">{{heading}}</span>
                    <paper-icon-button icon="refresh"></paper-icon-button>
                </paper-toolbar>
                <div id="content" class="container" fit layout vertical>
                    <iron-pages selected="{{selected}}">
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_Identification"></div>
                                    <paper-button id="create_identification" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_Lines"></div>
                                    <paper-button id="create_lines" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div id="page_DateTime"></div>
                        <div id="page_UserPreferences"></div>
                    </iron-pages>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>
    </template>

    <script>
    Polymer({
      is: 'polycom-template',
      properties: {
          menu: {
              type:Array,
              value: [
              'Identification',
              'Lines',
              'Date/Time',
              'User Preferences'
              ]
          }
      },
      addNew: function(phone) {
         this.$.addPhoneAction.body=JSON.stringify(phone);
         this.$.addPhoneAction.generateRequest();
      },
      modifyExisting: function(phone) {
         this.$.modifyPhoneAction.body=JSON.stringify(phone);
         this.$.modifyPhoneAction.generateRequest();
      },
      getExisting: function() {
         this.$.getPhoneAction.generateRequest();
      },
      phoneAdded: function(request) {
         alert("Phone added");
         phoneTemplate = document.querySelector('#polycomTemplate');
         phone = this.$.addPhoneAction.body
         phoneJson = JSON.parse(phone);
         phoneTemplate.serialNumber = phoneJson.serialNumber;
         phoneTemplate.getExisting();
      },
      phoneModified: function() {
         alert("Phone modified");
      },
      phoneRetrieved: function(request) {
        phone = request.detail.response;
        phone = JSON.stringify(phone);
        phoneTemplate = document.querySelector('#polycomTemplate');
        phoneTemplate.generateUI(phone, phoneTemplate.serialNumber);
      },
      generateUI: function(phone, serialNumber) {
          $("#page_Identification").alpaca({
              "schemaSource": "/phones/polycom/template/identification_schema",
              "optionsSource": "/phones/polycom/template/identification_options",
              "dataSource": phone,
              "postRender": function(control) {
                  $('#create_identification').click(function() {
                      save(control.getValue());
                  });
              }
          });
          if (serialNumber) {
              $("#page_Lines").alpaca({
                  "schemaSource": "/phones/polycom/template/lines_schema",
                  "optionsSource": "/phones/polycom/template/lines_options",
                  "dataSource": phone,
                  "postRender": function(control) {
                      $('#create_lines').click(function() {
                          save(control.getValue());
                      });
                  }
              });
          }
      }
    });

    function save(phone) {
        phoneTemplate = document.querySelector('#polycomTemplate');
        if(phoneTemplate.serialNumber) {
            phoneTemplate.modifyExisting(phone)
        } else {
            phoneTemplate.addNew(phone);
        }
    }

    document.addEventListener('WebComponentsReady', function() {
        serialNumber = $(location).attr('hash').replace("#","");
        phoneTemplate = document.querySelector('#polycomTemplate');
        phoneTemplate.heading = "Settings";
        phoneTemplate.serialNumber = serialNumber;
        if (serialNumber) {
            phoneTemplate.getExisting();
        } else {
            phoneTemplate.generateUI('{}');
        }
    });
    </script>

</dom-module>