<link rel="import" href="/assets/app/templates/customer-template.html">
<link rel="import" href="/assets/app/elements/custom-table.html">
<link rel="import" href="/assets/components/iron-icons/iron-icons.html"/>
<link rel="import" href="/assets/components/paper-fab/paper-fab.html"/>

<dom-module id="custom-form">
    <style>
        paper-fab.add{
            position: absolute;
            bottom: 10px;
            right: 70px;
            background-color: green;
        }
        paper-fab.delete{
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: green;
        }
    </style>
    <template>
        <iron-ajax
                id="deleteAccountAction"
                url="/api/accounts/delete/ids"
                method="POST"
                content-type="application/json"
                on-response="accountDeleted"
                handle-as="json">
        </iron-ajax>
        <template is="dom-if" if="{{list}}">
            <custom-table url="{{url}}" columns="{{columns}}"></custom-table>
            <paper-fab icon="add" on-tap="handleTap" on-click="handleClick" class="add"></paper-fab>
            <paper-fab icon="delete" on-tap="handleDelete" class="delete"></paper-fab>
        </template>
        <template is="dom-if" if="{{add}}">
            <customer-template></customer-template>
        </template>
    </template>
</dom-module>
<script>
    Polymer({
      is: 'custom-form',
      properties: {
        list: {
          type: Boolean,
          value: true
        },
        add: {
          type: Boolean,
          value: false
        },
        key: {
          type: String,
          value: ''
        }
      },

      handleTap: function() {
        form = document.querySelector('custom-form');
        form.key = '';
        this.list = false;
        this.add = true;
      },

      accountDeleted: function() {
        alert('deleted');
        customTable = document.querySelector('custom-table');
        customTable.querySelector('iron-ajax').generateRequest();
      },

      handleClick: function() {
        form = document.querySelector('custom-form');
        var key = form.key;

        accountTemplate = document.querySelector('customer-template');
        if (accountTemplate.selected == -1) {
            accountTemplate.selected = 0;
        }
        if (key) {
            accountTemplate.accountName = key;
            accountTemplate.getExisting();
        } else {
            accountTemplate.accountName = '';
            accountTemplate.generateUI('{}');
        }
        accountTemplate.querySelector('#close').addEventListener('tap', function() {
            form.list = true;
            form.add = false;
            customTable = document.querySelector('custom-table');
            customTable.querySelector('iron-ajax').generateRequest();
        });
      },
      handleDelete: function() {
        var table = document.querySelector('custom-table');
        var grid = table.querySelector('vaadin-grid');
        var selectedItems = grid.selection.selected();
        var jsonIds = {};
        var ids = [];
        var i;
        for (i=0; i < selectedItems.length; i++) {
           var id = grid.items[selectedItems[i]][0];
           var jsonId = {};
           jsonId['id'] = id;
           ids.push(jsonId);
        }
        jsonIds['ids'] = ids;

        this.$.deleteAccountAction.body = JSON.stringify(jsonIds);
        this.$.deleteAccountAction.generateRequest();
      },
      handleDeleteOne: function(id) {
        var jsonIds = {};
        var ids = [];
        var jsonId = {};
        jsonId['id'] = id;
        ids.push(jsonId);
        jsonIds['ids'] = ids;

        this.$.deleteAccountAction.body = JSON.stringify(jsonIds);
        this.$.deleteAccountAction.generateRequest();
      },
      handleOp: function() {
        var table = document.querySelector('custom-table');
        alert(table.operation);
      }
    });

    document.addEventListener('WebComponentsReady', function() {
        var form = document.querySelector('custom-form');
        var table = document.querySelector('custom-table');
        var listBox = table.querySelector('#operationMenu').querySelector('paper-listbox');

        var paperItem0 = listBox.querySelector('#id0');
        paperItem0.addEventListener('tap', function() {
            form.handleTap();
        });
        paperItem0.addEventListener('click', function() {
            accountTemplate = document.querySelector('customer-template');
            form.key = paperItem0.getAttribute("key");
            form.handleClick();
        });

        var paperItem1 = listBox.querySelector('#id1');
        paperItem1.addEventListener('tap', function() {
            form.handleDeleteOne(paperItem1.getAttribute("key"));
        });
    })
</script>