<link rel="import" href="/assets/app/elements/custom-template.html">
<link rel="import" href="/assets/app/elements/custom-table.html">
<link rel="import" href="/assets/components/iron-icons/iron-icons.html"/>
<link rel="import" href="/assets/components/paper-fab/paper-fab.html"/>

<dom-module id="custom-form">
    <style>
        paper-fab.add{
        position: absolute;
        bottom: 10px;
        right: 70px;
        background-color: green;
        }
        paper-fab.delete{
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: green;
        }
    </style>
    <template>
        <iron-ajax
                id="deleteAction"
                url="{{deleteIdsUrl}}"
                method="POST"
                content-type="application/json"
                on-response="deleted"
                handle-as="json">
        </iron-ajax>
        <template is="dom-if" if="{{list}}">
            <custom-table url="{{url}}" columns="{{columns}}"></custom-table>
            <paper-fab icon="add" on-tap="handleTap" on-click="handleClick" class="add"></paper-fab>
            <paper-fab icon="delete" on-tap="handleDelete" class="delete"></paper-fab>
        </template>
        <template is="dom-if" if="{{add}}">
            <custom-template pages={{pages}}></custom-template>
        </template>
    </template>
</dom-module>
<script>
    Polymer({
      is: 'custom-form',
      properties: {
        list: {
          type: Boolean,
          value: true
        },
        add: {
          type: Boolean,
          value: false
        },
        key: {
          type: String,
          value: ''
        },
        addUrl: {
          type: String
        },
        modifyUrl: {
          type: String
        },
        getUrl: {
          type: String
        },
        deleteIdsUrl: {
          type: String
        },
        pages: {
          type: Array
        }
      },

      handleTap: function() {
        form = document.querySelector('custom-form');
        form.key = '';
        this.list = false;
        this.add = true;
      },

      deleted: function() {
        alert('deleted');
        customTable = document.querySelector('custom-table');
        customTable.querySelector('iron-ajax').generateRequest();
      },

      handleClick: function() {
        form = document.querySelector('custom-form');
        var key = form.key;

        customTemplate = document.querySelector('custom-template');

        customTemplate.addUrl = this.addUrl;
        customTemplate.modifyUrl = this.modifyUrl;
        customTemplate.getUrl = this.getUrl;

        if (customTemplate.selected == -1) {
            customTemplate.selected = 0;
        }
        if (key) {
            customTemplate.id = key;
            customTemplate.modifyUrl = this.modifyUrl + key;
            customTemplate.getUrl = this.getUrl + key;
            customTemplate.getExisting();
        } else {
            customTemplate.id = '';
            customTemplate.generateUI('{}');
        }
        customTemplate.querySelector('#close').addEventListener('tap', function() {
            form.list = true;
            form.add = false;
            customTable = document.querySelector('custom-table');
            customTable.querySelector('iron-ajax').generateRequest();
        });
      },
      handleDelete: function() {
        var table = document.querySelector('custom-table');
        var grid = table.querySelector('vaadin-grid');
        var selectedItems = grid.selection.selected();
        var jsonIds = {};
        var ids = [];
        var i;
        for (i=0; i < selectedItems.length; i++) {
           var id = grid.items[selectedItems[i]][0];
           var jsonId = {};
           jsonId['id'] = id;
           ids.push(jsonId);
        }
        jsonIds['ids'] = ids;

        this.$.deleteAction.body = JSON.stringify(jsonIds);
        this.$.deleteAction.generateRequest();
      },
      handleDeleteOne: function(id) {
        var jsonIds = {};
        var ids = [];
        var jsonId = {};
        jsonId['id'] = id;
        ids.push(jsonId);
        jsonIds['ids'] = ids;

        this.$.deleteAction.body = JSON.stringify(jsonIds);
        this.$.deleteAction.generateRequest();
      }
    });

    document.addEventListener('WebComponentsReady', function() {
        var form = document.querySelector('custom-form');
        var table = document.querySelector('custom-table');
        var listBox = table.querySelector('#operationMenu').querySelector('paper-listbox');

        var paperItem0 = listBox.querySelector('#id0');
        paperItem0.addEventListener('tap', function() {
            form.handleTap();
        });
        paperItem0.addEventListener('click', function() {
            customTemplate = document.querySelector('custom-template');
            form.key = paperItem0.getAttribute("key");
            form.handleClick();
        });

        var paperItem1 = listBox.querySelector('#id1');
        paperItem1.addEventListener('tap', function() {
            form.handleDeleteOne(paperItem1.getAttribute("key"));
        });
    })
</script>