<link rel="import" href="/assets/components/polymer/polymer.html">
<link rel="import" href="/assets/components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/assets/components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/assets/components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/assets/components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/assets/components/iron-icons/iron-icons.html">
<link rel="import" href="/assets/components/paper-styles/paper-styles.html">
<link rel="import" href="/assets/components/paper-menu/paper-menu.html">
<link rel="import" href="/assets/components/paper-item/paper-item.html">
<link rel="import" href="/assets/components/iron-pages/iron-pages.html">
<link rel="import" href="/assets/components/iron-ajax/iron-ajax.html">
<link rel="import" href="/assets/components/paper-button/paper-button.html">

<link type="text/css" rel="stylesheet" href="/assets/components/bootstrap/dist/css/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="/assets/components/alpaca/dist/alpaca/bootstrap/alpaca.min.css">

<script type="text/javascript" src="/assets/components/bootstrap-multiselect/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript" src="/assets/components/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/components/handlebars/handlebars.js"></script>
<script type="text/javascript" src="/assets/components/alpaca/dist/alpaca/bootstrap/alpaca.min.js"></script>

<dom-module id="polycom-template">
    <style>
        paper-header-panel[main]{
        background-color: var(--paper-grey-100);
        }
        paper-header-panel[drawer]{
        background-color: var(--paper-grey-200);
        }
        paper-menu.menu{
        background-color: var(--paper-grey-200);
        }
        paper-item.menu{
        background-color: var(--paper-grey-200);
        }
        paper-toolbar.main{
        background-color: var(--paper-green-300);
        color: black;
        font-size: 24px;
        }
        paper-toolbar.drawer{
        background-color: var(--paper-green-300);
        }
        paper-button.colored {
        color: black;
        background-color: var(--paper-grey-400);
        }
    </style>
    <template>
        <iron-ajax
                id="addPhoneAction"
                url="/api/phones/add"
                method="POST"
                content-type="application/json"
                on-response="phoneAdded"
                handle-as="json">
        </iron-ajax>
        <iron-ajax
                id="modifyPhoneAction"
                url="/api/phones/modify/{{serialNumber}}"
                method="POST"
                content-type="application/json"
                on-response="phoneModified"
                handle-as="json">
        </iron-ajax>
        <iron-ajax
                id="getPhoneAction"
                url="/api/phones/get/{{serialNumber}}"
                method="GET"
                on-response="phoneRetrieved"
                handle-as="json">
        </iron-ajax>
        <paper-drawer-panel>
            <paper-header-panel drawer>
                <paper-toolbar class="drawer">
                </paper-toolbar>
                <paper-menu selected="{{selected}}" class="menu">
                    <template is="dom-repeat" items="{{menu}}">
                        <paper-item class="menu">{{item}}</paper-item>
                    </template>
                </paper-menu>
            </paper-header-panel>
            <paper-header-panel main>
                <paper-toolbar class="main">
                    <paper-icon-button paper-drawer-toggle icon="menu"></paper-icon-button>
                    <span title class="flex">{{heading}}</span>
                    <paper-icon-button icon="refresh"></paper-icon-button>
                </paper-toolbar>
                <div id="content" class="container" fit layout vertical>
                    <iron-pages selected="{{selected}}">
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_Identification"></div>
                                    <paper-button id="create_identification" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_Lines"></div>
                                    <paper-button id="create_lines" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_DateTime"></div>
                                    <paper-button id="create_dateTime" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_UserPreferences"></div>
                                    <paper-button id="create_userPreferences" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_Dtmf"></div>
                                    <paper-button id="create_dtmf" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_SoundEffects"></div>
                                    <paper-button id="create_soundEffects" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_VoiceCodecs"></div>
                                    <paper-button id="create_voiceCodecs" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_Video"></div>
                                    <paper-button id="create_video" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_VoiceQMonitoring"></div>
                                    <paper-button id="create_voiceQMonitoring" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_QualityOfService"></div>
                                    <paper-button id="create_qualityOfService" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_Sntp"></div>
                                    <paper-button id="create_sntp" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                        <div class="container" style="margin-top:30px">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="page_Rtp"></div>
                                    <paper-button id="create_rtp" class="colored">Save</paper-button>
                                </div>
                            </div>
                        </div>
                    </iron-pages>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>
    </template>

    <script>
    Polymer({
      is: 'polycom-template',
      properties: {
          menu: {
              type:Array,
              value: [
              'Identification',
              'Lines',
              'Date/Time',
              'User Preferences',
              'DTMF',
              'Sound Effects',
              'Voice/Codecs',
              'Video',
              'Voice Quality Monitoring',
              'Quality of Service',
              'SNTP',
              'RTP'
              ]
          }
      },
      addNew: function(phone) {
         this.$.addPhoneAction.body=JSON.stringify(phone);
         this.$.addPhoneAction.generateRequest();
      },
      modifyExisting: function(phone) {
         this.$.modifyPhoneAction.body=JSON.stringify(phone);
         this.$.modifyPhoneAction.generateRequest();
      },
      getExisting: function() {
         this.$.getPhoneAction.generateRequest();
      },
      phoneAdded: function(request) {
         alert("Phone added");
         phoneTemplate = document.querySelector('#polycomTemplate');
         phone = this.$.addPhoneAction.body;
         phoneJson = JSON.parse(phone);
         //phone added, Identification form needs to be regenerated
         $("#page_Identification").alpaca("destroy");
         $('#create_identification').off("click");
         phoneTemplate.serialNumber = phoneJson.serialNumber;
         phoneTemplate.getExisting();
      },
      phoneModified: function() {
         alert("Phone modified");
      },
      phoneRetrieved: function(request) {
        phone = request.detail.response;
        phone = JSON.stringify(phone);
        phoneTemplate = document.querySelector('#polycomTemplate');
        phoneTemplate.generateUI(phone, phoneTemplate.serialNumber);
      },
      generateUI: function(phone, serialNumber) {
          generateAlpacaForm("#page_Identification", "identification_schema", "identification_options", phone, "#create_identification");
          if (serialNumber) {
              generateAlpacaForm("#page_Lines", "lines_schema", "lines_options", phone, "#create_lines");
              generateAlpacaForm("#page_DateTime", "dateTime_settings_schema", "dateTime_settings_options", phone, "#create_dateTime");
              generateAlpacaForm("#page_UserPreferences", "userPreferences_settings_schema", "userPreferences_settings_options", phone, "#create_userPreferences");
              generateAlpacaForm("#page_Dtmf", "dtmf_settings_schema", "dtmf_settings_options", phone, "#create_dtmf");
              generateAlpacaForm("#page_SoundEffects", "soundEffects_settings_schema", "soundEffects_settings_options", phone, "#create_soundEffects");
              generateAlpacaForm("#page_VoiceCodecs", "voiceCodecs_settings_schema", "voiceCodecs_settings_options", phone, "#create_voiceCodecs");
              generateAlpacaForm("#page_Video", "video_settings_schema", "video_settings_options", phone, "#create_video");
              generateAlpacaForm("#page_VoiceQMonitoring", "voiceQMonitoring_settings_schema", "voiceQMonitoring_settings_options", phone, "#create_voiceQMonitoring");
              generateAlpacaForm("#page_QualityOfService", "qualityOfService_settings_schema", "qualityOfService_settings_options", phone, "#create_qualityOfService");
              generateAlpacaForm("#page_Sntp", "sntp_settings_schema", "sntp_settings_options", phone, "#create_sntp");
              generateAlpacaForm("#page_Rtp", "rtp_settings_schema", "rtp_settings_options", phone, "#create_rtp");
          }
      }
    });

    function generateAlpacaForm(page, schemaName, optionsName, data, saveButton) {
        var schema = "/phones/polycom/template/" + schemaName;
        var options = "/phones/polycom/template/" + optionsName;
        $(page).alpaca({
            "schemaSource": schema,
            "optionsSource": options,
            "dataSource": data,
            "postRender": function(control) {
                $(saveButton).click(function() {
                    alert(JSON.stringify(control.getValue()));
                    save(control.getValue());
                });
            }
        });
    }

    function save(data) {
        phoneTemplate = document.querySelector('#polycomTemplate');
        if(phoneTemplate.serialNumber) {
            phoneTemplate.modifyExisting(data)
        } else {
        alert(JSON.stringify(data));
            phoneTemplate.addNew(data);
        }
    }

    document.addEventListener('WebComponentsReady', function() {
        serialNumber = $(location).attr('hash').replace("#","");
        phoneTemplate = document.querySelector('#polycomTemplate');
        phoneTemplate.heading = "Polycom VVX500";
        phoneTemplate.serialNumber = serialNumber;
        if (serialNumber) {
            phoneTemplate.getExisting();
        } else {
            phoneTemplate.generateUI('{}');
        }
    });
    </script>

</dom-module>