<link rel="import" href="/assets/components/polymer/polymer.html">
<link rel="import" href="/assets/components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/assets/components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/assets/components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/assets/components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/assets/components/iron-icons/iron-icons.html">
<link rel="import" href="/assets/components/paper-styles/paper-styles.html">
<link rel="import" href="/assets/components/paper-menu/paper-menu.html">
<link rel="import" href="/assets/components/paper-item/paper-item.html">
<link rel="import" href="/assets/components/iron-pages/iron-pages.html">
<link rel="import" href="/assets/components/iron-ajax/iron-ajax.html">
<link rel="import" href="/assets/components/paper-button/paper-button.html">

<dom-module id="customer-template">
    <style>
        paper-header-panel[main]{
        background-color: var(--paper-grey-100);
        }
        paper-header-panel[drawer]{
        background-color: var(--paper-grey-200);
        }
        paper-menu.menu{
        background-color: var(--paper-grey-200);
        }
        paper-item.menu{
        background-color: var(--paper-grey-200);
        }
        paper-toolbar.main{
        background-color: var(--paper-green-300);
        color: black;
        font-size: 24px;
        }
        paper-toolbar.drawer{
        background-color: var(--paper-green-300);
        }
        paper-button.colored {
        color: green;
        }
        paper-icon-button.close {
        margin-top:2px;
        margin-right:2px;
        }
    </style>
    <template>
        <iron-ajax
                id="addAccountAction"
                url="/api/accounts/add"
                method="POST"
                content-type="application/json"
                on-response="accountAdded"
                handle-as="json">
        </iron-ajax>
        <iron-ajax
                id="modifyAccountAction"
                url="/api/accounts/modify/{{accountName}}"
                method="POST"
                content-type="application/json"
                on-response="accountModified"
                handle-as="json">
        </iron-ajax>
        <iron-ajax
                id="getAccountAction"
                url="/api/accounts/get/{{accountName}}"
                method="GET"
                on-response="accountRetrieved"
                handle-as="json">
        </iron-ajax>
        <paper-drawer-panel>
            <paper-header-panel drawer>
                <paper-menu selected="{{selected}}" class="menu">
                    <template is="dom-repeat" items="{{menu}}">
                        <paper-item class="menu">{{item}}</paper-item>
                    </template>
                </paper-menu>
            </paper-header-panel>
            <paper-header-panel main>
                <div id="content">
                    <paper-card animated elevation="3" style="margin-top:10px;margin-left:10px;position:relative;width:95%;" fit layout vertical>
                        <div class="card-content" >
                            <paper-icon-button id="close" icon="close" class="close"></paper-icon-button>
                            <iron-pages selected="{{selected}}">
                                <div style="margin-top:30px">
                                    <div class="row">
                                        <div id="page_Identification"></div>
                                        <div class="card-actions">
                                            <paper-button id="create_identification" class="colored">Save</paper-button>
                                        </div>
                                    </div>
                                </div>
                            </iron-pages>
                        </div>
                    </paper-card>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>
    </template>

    <script>
    Polymer({
      is: 'customer-template',
      properties: {
          menu: {
              type:Array,
              value: [
              'Identification'
              ]
          },
          selected: {
              type: Number,
              value: -1
          }
      },
      addNew: function(account) {
         this.$.addAccountAction.body=JSON.stringify(account);
         this.$.addAccountAction.generateRequest();
      },
      modifyExisting: function(account) {
         this.$.modifyAccountAction.body=JSON.stringify(account);
         this.$.modifyAccountAction.generateRequest();
      },
      getExisting: function() {
         this.$.getAccountAction.generateRequest();
      },
      accountAdded: function(request) {
         alert("Account added");
         customerTemplate = document.querySelector('customer-template');
         account = this.$.addAccountAction.body;
         accountJson = JSON.parse(account);
         //account added, Identification form needs to be regenerated
         $("#page_Identification").alpaca("destroy");
         $('#create_identification').off("click");
         accountTemplate.accountName = accountJson.accountName;
         accountTemplate.getExisting();
      },
      accountModified: function() {
         alert("Account modified");
         customerTemplate = document.querySelector('customer-template');
         account = this.$.modifyAccountAction.body;
         accountJson = JSON.parse(account);
         //account modified, Identification form needs to be regenerated
         $("#page_Identification").alpaca("destroy");
         $('#create_identification').off("click");
         accountTemplate.accountName = accountJson.accountName;
         accountTemplate.getExisting();
      },
      accountRetrieved: function(request) {
        account = request.detail.response;
        account = JSON.stringify(account);
        accountTemplate = document.querySelector('customer-template');
        accountTemplate.generateUI(account);
      },
      accountDeleted: function(request) {
        alert('deleted');
        alert(request.detail.response);
      },
      generateUI: function(account) {
          generateAlpacaForm("#page_Identification", "identification_schema", "identification_options", account, "#create_identification");
      }
    });

    function generateAlpacaForm(page, schemaName, optionsName, data, saveButton) {
        var schema = "/customer/template/" + schemaName;
        var options = "/customer/template/" + optionsName;
        $(page).alpaca({
            "schemaSource": schema,
            "optionsSource": options,
            "dataSource": data,
            "postRender": function(control) {
                $(saveButton).click(function() {
                    save(control.getValue());
                });
            }
        });
    }

    function save(data) {
        customerTemplate = document.querySelector('customer-template');
        if(customerTemplate.accountName) {
            accountTemplate.modifyExisting(data)
        } else {
            accountTemplate.addNew(data);
        }
    }
    </script>

</dom-module>